# 性能优化方案

## 当前问题诊断

### 训练结果分析（v1.0.3 初始版本）

**性能指标**：
- 最终测试准确率：**89.06%**（目标：≥90%）
- 最终稀疏度：**46.5%**（保留 53.5% 连接，过于稠密）
- 训练轮数：10 epochs
- 神经元数量：1000

**关键问题**：

1. **初始连接过多**
   - 配置：`INITIAL_SPARSITY = 0.6`（预期保留 40% 连接）
   - 实际：初始连接数 ~40万（保留 80% 连接）
   - 原因：拓扑感知初始化从 `valid_connections` 中采样，实际创建了更多连接

2. **Epoch 5 大规模剪枝**
   - 连接数从 40万 骤降到 31万（剪枝 9万，-22.5%）
   - 变化率峰值达到 **27%**（远超目标 5-10%）
   - 说明网络发现大量初始连接是无用的

3. **准确率不足**
   - 测试准确率 89.06%，低于 Fashion-MNIST 预期（90-92%）
   - 训练准确率 ~89%，存在轻微欠拟合

4. **可塑性过于激进**
   - Epoch 5 的剧烈变化影响训练稳定性
   - 后续 epochs 变化率趋于 0，可塑性机制几乎停止工作

---

## 优化方案

### 方案 1：大幅提高初始稀疏度 ⭐⭐⭐

**问题**：初始连接过多（40万），导致 Epoch 5 大规模剪枝

**解决**：
```python
# 从 0.6 提高到 0.75
INITIAL_SPARSITY = 0.75  # 只保留 25% 连接
```

**预期效果**：
- 初始连接数：~12.5万（而非 40万）
- 避免 Epoch 5 的大规模剪枝
- 让可塑性机制逐步生长需要的连接
- 更稳定的训练过程

**原理**：
- 从稀疏状态开始，网络通过可塑性机制主动生长需要的连接
- 避免"先创建大量连接，再大规模剪枝"的低效模式
- 符合生物神经网络的发育过程（先稀疏，后选择性强化）

---

### 方案 2：增加训练轮数 ⭐⭐⭐

**问题**：10 epochs 不足以充分训练

**解决**：
```python
# 从 10 增加到 15
EPOCHS = 15
```

**预期效果**：
- 准确率提升 1-2%
- 网络有更多时间调整拓扑
- 更充分的学习

---

### 方案 3：降低剪枝阈值 ⭐⭐

**问题**：`PRUNE_THRESHOLD = 0.015` 导致过于激进的剪枝

**解决**：
```python
# 从 0.015 降低到 0.01
PRUNE_THRESHOLD = 0.01
```

**预期效果**：
- 剪枝更保守，避免误剪有用连接
- 减少 Epoch 5 的剧烈变化
- 更平滑的拓扑演化

---

### 方案 4：增加神经元数量 ⭐⭐

**问题**：1000 神经元可能容量不足

**解决**：
```python
# 从 1000 增加到 1500
NUM_NEURONS = 1500
```

**预期效果**：
- 模型容量提升 50%
- 准确率提升 1-2%
- 训练时间增加 ~50%（可接受）

**权衡**：
- 内存使用：~4GB（1000 神经元）→ ~6GB（1500 神经元）
- 训练时间：~30s/epoch → ~45s/epoch

---

### 方案 5：降低学习率 ⭐

**问题**：`LEARNING_RATE = 0.001` 配合 10 epochs 可能过快

**解决**：
```python
# 从 0.001 降低到 0.0008
LEARNING_RATE = 0.0008
```

**预期效果**：
- 配合 15 epochs，实现更稳定的收敛
- 避免过拟合
- 更精细的参数调整

---

## 预期改进效果

### 保守估计

| 指标 | 当前 | 优化后 | 提升 |
|------|------|--------|------|
| **测试准确率** | 89.06% | 90-91% | +1-2% |
| **最终稀疏度** | 46.5% | 55-65% | +8-18% |
| **Epoch 5 变化率** | 27% | <10% | -17% |
| **训练稳定性** | 中等 | 良好 | ✓ |
| **训练时间/epoch** | 29s | 40-50s | +38-72% |

### 乐观估计

| 指标 | 当前 | 优化后 | 提升 |
|------|------|--------|------|
| **测试准确率** | 89.06% | 91-92% | +2-3% |
| **最终稀疏度** | 46.5% | 60-70% | +13-23% |
| **可塑性活跃度** | 不稳定 | 稳定在 5-10% | ✓ |

---

## 实施步骤

### 步骤 1：应用所有优化（已完成）

所有配置已更新到 `config.py`：
- ✅ `INITIAL_SPARSITY = 0.75`
- ✅ `EPOCHS = 15`
- ✅ `PRUNE_THRESHOLD = 0.01`
- ✅ `NUM_NEURONS = 1500`
- ✅ `LEARNING_RATE = 0.0008`

### 步骤 2：运行优化后的训练

```bash
cd v1.0.3
python run_with_config.py
```

### 步骤 3：验证改进效果

**关键指标**：
1. **初始连接数**：应该在 10-15万（而非 40万）
2. **Epoch 5 变化率**：应该 <10%（而非 27%）
3. **最终准确率**：应该 ≥90%
4. **最终稀疏度**：应该 55-70%

**验证命令**：
```python
# 查看性能数据
import json
with open('results/v1_0_3_optimized_plastic_net_mnist_performance.json') as f:
    data = json.load(f)
    print(f"Final accuracy: {data['final_accuracy']:.2f}%")
    print(f"Final sparsity: {data['final_sparsity']:.2%}")
```

### 步骤 4：对比分析

**对比项**：
- 训练历史曲线（loss、accuracy、连接数、变化率）
- Epoch 5 的行为（是否还有大规模剪枝）
- 最终性能指标

---

## 进一步优化方向

### 如果准确率仍不足 (<90%)

**选项 A：增加模型容量**
```python
NUM_NEURONS = 2000  # 进一步增加
ITERATIONS = 7      # 增加内部迭代
```

**选项 B：调整数据增强**
```python
# 在 experiments/v1_0_3_mnist_baseline.py 中
# 减少数据增强强度，避免过度正则化
transforms.RandomRotation(3)  # 从 5 度减少到 3 度
```

**选项 C：调整学习率调度**
```python
# 在 training/v1_0_3_engine.py 中
# 调整 T_0 参数
self.scheduler = optim.lr_scheduler.CosineAnnealingWarmRestarts(
    self.optimizer,
    T_0=3,  # 从 5 改为 3，更频繁的重启
    T_mult=2,
    eta_min=lr * 0.01
)
```

---

### 如果可塑性仍然过于激进

**选项 A：进一步提高初始稀疏度**
```python
INITIAL_SPARSITY = 0.8  # 只保留 20% 连接
```

**选项 B：增加保护期**
```python
PROTECTION_PERIOD = 80  # 从 60 增加到 80
```

**选项 C：降低生长阈值**
```python
GROWTH_THRESHOLD = 0.25  # 从 0.2 提高到 0.25
```

---

### 如果训练时间过长

**选项 A：减少神经元数量**
```python
NUM_NEURONS = 1200  # 折中方案
```

**选项 B：增加可塑性更新间隔**
```python
PLASTICITY_INTERVAL = 50  # 从 40 增加到 50
```

**选项 C：减少训练轮数**
```python
EPOCHS = 12  # 折中方案
```

---

## 风险评估

### 低风险修改 ✅
- 调整 `INITIAL_SPARSITY`（易于回退）
- 增加 `EPOCHS`（只影响训练时间）
- 调整 `LEARNING_RATE`（标准操作）

### 中风险修改 ⚠️
- 增加 `NUM_NEURONS`（可能内存不足）
  - **缓解**：监控 GPU 内存，必要时减少 `BATCH_SIZE`
- 调整 `PRUNE_THRESHOLD`（可能影响可塑性）
  - **缓解**：观察变化率，必要时回退

### 高风险修改 ❌
- 修改拓扑管理器逻辑（不推荐）
- 修改可塑性核心算法（不推荐）

---

## 总结

### 核心改进

1. **初始稀疏度 0.6 → 0.75**：解决初始连接过多的根本问题
2. **训练轮数 10 → 15**：给网络更多学习时间
3. **神经元数量 1000 → 1500**：提升模型容量

### 预期结果

- ✅ 测试准确率：89.06% → **90-92%**
- ✅ 训练稳定性：显著提升
- ✅ 可塑性行为：更平滑、更可控
- ✅ 最终稀疏度：更合理（55-70%）

### 下一步

运行优化后的训练，验证改进效果：
```bash
cd v1.0.3
python run_with_config.py
```

---

**创建日期**：2026-02-04
**版本**：v1.0.3 性能优化
**状态**：配置已更新，待验证

